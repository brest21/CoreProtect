name: Auto Build & Release Latest CoreProtect

on:
  schedule:
    - cron: "0 6 * * *"  # every day at 6 AM UTC
  workflow_dispatch:      # allow manual trigger

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Checkout your fork
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2ï¸âƒ£ Pull latest changes from upstream
      - name: Pull latest CoreProtect source
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote add upstream https://github.com/PlayPro/CoreProtect.git || true
          git fetch upstream
          git merge upstream/master --no-edit --allow-unrelated-histories || true

      # 3ï¸âƒ£ Set up Java 21
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21

      # 4ï¸âƒ£ Verify Java version (optional but helps debug)
      - name: Verify Java version
        run: java -version && javac -version

      # 5ï¸âƒ£ Clean old Paper API artifacts
      - name: Clean Paper API cache
        run: rm -rf ~/.m2/repository/io/papermc

      # 6ï¸âƒ£ Build with Maven
      - name: Build CoreProtect
        run: mvn -U -B -DskipTests clean package

      # 7ï¸âƒ£ Get commit hash and date for release naming
      - name: Get build info
        id: vars
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "date=$(date +'%Y-%m-%d')" >> $GITHUB_OUTPUT

      # 8ï¸âƒ£ Create a GitHub Release
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly-${{ steps.vars.outputs.date }}-${{ steps.vars.outputs.sha_short }}
          name: CoreProtect Nightly Build â€“ ${{ steps.vars.outputs.date }}
          body: |
            ğŸ—ï¸ Automatic nightly build of CoreProtect
            - Commit: `${{ steps.vars.outputs.sha_short }}`
            - Build date: `${{ steps.vars.outputs.date }}`
          files: target/*.jar
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
